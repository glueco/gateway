{"version":3,"sources":["../src/proxy.ts"],"sourcesContent":["// ============================================\n// TEMPLATE PLUGIN PROXY\n// Server-side plugin implementation for the gateway\n// ============================================\n//\n// This module is imported by the proxy to handle plugin requests.\n// It should NOT be imported by target apps.\n//\n// IMPORTANT: This entrypoint is for PROXY only.\n// - Do NOT import client code here\n// - Do NOT use browser-only APIs\n// - Keep Node-specific code here\n//\n// Import path: @glueco/plugin-template/proxy\n// ============================================\n\nimport type {\n  PluginContract,\n  PluginResourceConstraints,\n  PluginValidationResult,\n  PluginExecuteContext,\n  PluginExecuteOptions,\n  PluginExecuteResult,\n  PluginUsageMetrics,\n  PluginMappedError,\n} from \"@glueco/shared\";\nimport { createPluginBase } from \"@glueco/shared\";\n\nimport {\n  ActionOneRequestSchema,\n  ActionTwoRequestSchema,\n  PLUGIN_ID,\n  RESOURCE_TYPE,\n  PROVIDER,\n  VERSION,\n  NAME,\n  ACTIONS,\n  ENFORCEMENT_SUPPORT,\n  DEFAULT_API_URL,\n} from \"./contracts\";\n\n// ============================================\n// ERROR HANDLING\n// ============================================\n\nclass ProviderApiError extends Error {\n  constructor(\n    public status: number,\n    public body: string,\n  ) {\n    super(`Provider API error: ${status}`);\n    this.name = \"ProviderApiError\";\n  }\n}\n\nfunction mapProviderError(error: ProviderApiError): PluginMappedError {\n  const message = error.body;\n\n  switch (error.status) {\n    case 400:\n      return { status: 400, code: \"BAD_REQUEST\", message, retryable: false };\n    case 401:\n      return {\n        status: 401,\n        code: \"UNAUTHORIZED\",\n        message: \"Invalid API key\",\n        retryable: false,\n      };\n    case 403:\n      return { status: 403, code: \"FORBIDDEN\", message, retryable: false };\n    case 404:\n      return { status: 404, code: \"NOT_FOUND\", message, retryable: false };\n    case 429:\n      return { status: 429, code: \"RATE_LIMITED\", message, retryable: true };\n    case 500:\n    case 502:\n    case 503:\n      return {\n        status: error.status,\n        code: \"PROVIDER_ERROR\",\n        message,\n        retryable: true,\n      };\n    default:\n      return {\n        status: error.status,\n        code: \"UNKNOWN\",\n        message,\n        retryable: false,\n      };\n  }\n}\n\n// ============================================\n// PLUGIN IMPLEMENTATION\n// ============================================\n\nconst templatePlugin: PluginContract = {\n  // Use createPluginBase for defaults\n  ...createPluginBase({\n    id: PLUGIN_ID,\n    resourceType: RESOURCE_TYPE,\n    provider: PROVIDER,\n    version: VERSION,\n    name: NAME,\n    actions: [...ACTIONS],\n    supports: {\n      enforcement: [...ENFORCEMENT_SUPPORT],\n    },\n    // Client contract metadata for SDK-compatible plugins\n    // This makes the plugin \"SDK-compatible\" per the architecture rules\n    client: {\n      namespace: \"template\",\n      actions: {\n        \"action.one\": {\n          description: \"Execute action one - example action\",\n        },\n        \"action.two\": {\n          description: \"Execute action two - example action\",\n        },\n      },\n    },\n  }),\n\n  // Optional: Reference to core extractor or custom config\n  extractors: {\n    \"action.one\": {\n      type: \"generic\", // Use \"openai-compatible\", \"gemini\", or \"generic\"\n    },\n    \"action.two\": {\n      type: \"generic\",\n    },\n  },\n\n  // Optional: Credential schema for admin UI\n  credentialSchema: {\n    fields: [\n      {\n        name: \"apiKey\",\n        type: \"secret\",\n        label: \"API Key\",\n        description: \"Your provider API key\",\n        required: true,\n      },\n      {\n        name: \"baseUrl\",\n        type: \"url\",\n        label: \"Base URL\",\n        description: \"Custom API base URL (optional)\",\n        required: false,\n        default: DEFAULT_API_URL,\n      },\n    ],\n  },\n\n  /**\n   * Validate input and apply constraints.\n   * This is called before execute() to ensure the request is valid.\n   */\n  validateAndShape(\n    action: string,\n    input: unknown,\n    constraints: PluginResourceConstraints,\n  ): PluginValidationResult {\n    // Check if action is supported\n    if (!ACTIONS.includes(action as typeof ACTIONS[number])) {\n      return { valid: false, error: `Unsupported action: ${action}` };\n    }\n\n    // Select schema based on action\n    const schema =\n      action === \"action.one\"\n        ? ActionOneRequestSchema\n        : ActionTwoRequestSchema;\n\n    // Parse and validate input\n    const parsed = schema.safeParse(input);\n    if (!parsed.success) {\n      return {\n        valid: false,\n        error: `Invalid request: ${parsed.error.errors.map((e) => e.message).join(\", \")}`,\n      };\n    }\n\n    // TODO: Apply constraints here\n    // Example:\n    // if (constraints.field1 && parsed.data.field1 !== constraints.field1) {\n    //   return { valid: false, error: \"field1 constraint violated\" };\n    // }\n\n    return { valid: true, shapedInput: parsed.data };\n  },\n\n  /**\n   * Execute the action against the upstream provider.\n   * This is where you make the actual API call.\n   */\n  async execute(\n    action: string,\n    shapedInput: unknown,\n    ctx: PluginExecuteContext,\n    options: PluginExecuteOptions,\n  ): Promise<PluginExecuteResult> {\n    const baseUrl = (ctx.config?.baseUrl as string) || DEFAULT_API_URL;\n\n    // Build the request for your provider\n    const endpoint = `${baseUrl}/${action.replace(\".\", \"/\")}`;\n\n    const response = await fetch(endpoint, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${ctx.secret}`,\n      },\n      body: JSON.stringify(shapedInput),\n      signal: options.signal,\n    });\n\n    if (!response.ok) {\n      const errorBody = await response.text();\n      throw new ProviderApiError(response.status, errorBody);\n    }\n\n    // Handle streaming if supported\n    if (options.stream && response.body) {\n      return {\n        stream: response.body,\n        contentType: \"text/event-stream\",\n      };\n    }\n\n    // Non-streaming response\n    const json = await response.json();\n    return {\n      response: json,\n      contentType: \"application/json\",\n      usage: this.extractUsage(json),\n    };\n  },\n\n  /**\n   * Extract usage metrics from the response.\n   * Used for auditing and budget tracking.\n   */\n  extractUsage(response: unknown): PluginUsageMetrics {\n    const res = response as Record<string, unknown>;\n\n    return {\n      // Customize for your provider's response format\n      custom: {\n        rawUsage: res.usage,\n      },\n    };\n  },\n\n  /**\n   * Map provider-specific errors to standardized format.\n   */\n  mapError(error: unknown): PluginMappedError {\n    if (error instanceof ProviderApiError) {\n      return mapProviderError(error);\n    }\n\n    return {\n      status: 500,\n      code: \"INTERNAL_ERROR\",\n      message: error instanceof Error ? error.message : \"Unknown error\",\n      retryable: false,\n    };\n  },\n};\n\n// Export as default (required for plugin loading)\nexport default templatePlugin;\n\n// Also export named for flexibility\nexport { templatePlugin };\n"],"mappings":"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","names":[]}