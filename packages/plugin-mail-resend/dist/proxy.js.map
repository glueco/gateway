{"version":3,"sources":["../src/proxy.ts","../src/contracts.ts"],"sourcesContent":["// ============================================\n// RESEND PLUGIN PROXY\n// Server-side plugin implementation for the gateway\n// ============================================\n//\n// This module is imported by the proxy to handle Resend email requests.\n// It should NOT be imported by target apps.\n//\n// Import path: @glueco/plugin-mail-resend/proxy\n// ============================================\n\nimport type {\n  PluginContract,\n  PluginResourceConstraints,\n  PluginValidationResult,\n  PluginExecuteContext,\n  PluginExecuteOptions,\n  PluginExecuteResult,\n  PluginUsageMetrics,\n  PluginMappedError,\n  EnforcementFields,\n} from \"@glueco/shared\";\nimport { createPluginBase } from \"@glueco/shared\";\n\nimport {\n  SendEmailRequestSchema,\n  type SendEmailRequest,\n  type ShapedSendEmailRequest,\n  type ResendEnforcementFields,\n  PLUGIN_ID,\n  RESOURCE_TYPE,\n  PROVIDER,\n  VERSION,\n  PLUGIN_NAME,\n  ACTIONS,\n  ENFORCEMENT_SUPPORT,\n  extractDomain,\n  normalizeToArray,\n  extractUniqueDomains,\n} from \"./contracts\";\n\n// ============================================\n// CONFIGURATION\n// ============================================\n\nconst RESEND_API_URL = \"https://api.resend.com\";\nconst DEFAULT_TIMEOUT_MS = 30_000;\n\n// ============================================\n// ERROR HANDLING\n// ============================================\n\nclass ResendApiError extends Error {\n  constructor(\n    public status: number,\n    public body: string,\n  ) {\n    super(`Resend API error: ${status}`);\n    this.name = \"ResendApiError\";\n  }\n}\n\nfunction mapResendError(error: ResendApiError): PluginMappedError {\n  let parsed: { message?: string; name?: string; statusCode?: number } = {};\n  try {\n    parsed = JSON.parse(error.body);\n  } catch {\n    // Ignore parse errors\n  }\n\n  const message = parsed.message || error.body;\n\n  switch (error.status) {\n    case 400:\n      return { status: 400, code: \"BAD_REQUEST\", message, retryable: false };\n    case 401:\n      return {\n        status: 401,\n        code: \"UNAUTHORIZED\",\n        message: \"Invalid API key\",\n        retryable: false,\n      };\n    case 403:\n      return { status: 403, code: \"FORBIDDEN\", message, retryable: false };\n    case 404:\n      return { status: 404, code: \"NOT_FOUND\", message, retryable: false };\n    case 422:\n      return {\n        status: 422,\n        code: \"VALIDATION_ERROR\",\n        message,\n        retryable: false,\n      };\n    case 429:\n      return { status: 429, code: \"RATE_LIMITED\", message, retryable: true };\n    case 500:\n    case 502:\n    case 503:\n      return {\n        status: error.status,\n        code: \"PROVIDER_ERROR\",\n        message,\n        retryable: true,\n      };\n    default:\n      return {\n        status: error.status,\n        code: \"UNKNOWN\",\n        message,\n        retryable: false,\n      };\n  }\n}\n\n// ============================================\n// ENFORCEMENT HELPERS\n// ============================================\n\n/**\n * Extract enforcement fields from shaped request.\n * These are used for policy enforcement.\n */\nfunction extractEnforcementFields(\n  shaped: ShapedSendEmailRequest,\n): ResendEnforcementFields {\n  const allRecipients = [\n    ...shaped.to,\n    ...(shaped.cc || []),\n    ...(shaped.bcc || []),\n  ];\n\n  return {\n    fromDomain: extractDomain(shaped.from),\n    toDomains: extractUniqueDomains(allRecipients),\n    recipientCount: allRecipients.length,\n    hasHtml: !!shaped.html,\n    hasAttachments:\n      Array.isArray(shaped.attachments) && shaped.attachments.length > 0,\n  };\n}\n\n/**\n * Convert ResendEnforcementFields to shared EnforcementFields format.\n */\nfunction toSharedEnforcement(\n  fields: ResendEnforcementFields,\n): EnforcementFields {\n  return {\n    fromDomain: fields.fromDomain,\n    toDomains: fields.toDomains,\n    recipientCount: fields.recipientCount,\n  };\n}\n\n// ============================================\n// PLUGIN IMPLEMENTATION\n// ============================================\n\nconst resendPlugin: PluginContract = {\n  ...createPluginBase({\n    id: PLUGIN_ID,\n    resourceType: RESOURCE_TYPE,\n    provider: PROVIDER,\n    version: VERSION,\n    name: PLUGIN_NAME,\n    actions: [...ACTIONS],\n    supports: {\n      enforcement: [...ENFORCEMENT_SUPPORT],\n    },\n    // Client contract metadata for SDK-compatible plugins\n    client: {\n      namespace: \"resend\",\n      actions: {\n        \"emails.send\": {\n          description: \"Send transactional emails via Resend\",\n        },\n      },\n    },\n  }),\n\n  // Credential schema for UI\n  credentialSchema: {\n    fields: [\n      {\n        name: \"apiKey\",\n        type: \"secret\",\n        label: \"API Key\",\n        description: \"Your Resend API key (starts with re_)\",\n        required: true,\n      },\n    ],\n  },\n\n  validateAndShape(\n    action: string,\n    input: unknown,\n    constraints: PluginResourceConstraints,\n  ): PluginValidationResult {\n    if (action !== \"emails.send\") {\n      return { valid: false, error: `Unsupported action: ${action}` };\n    }\n\n    // Parse input - schema-first validation\n    const parsed = SendEmailRequestSchema.safeParse(input);\n    if (!parsed.success) {\n      const errors = parsed.error.errors.map((e) => {\n        const path = e.path.join(\".\");\n        return path ? `${path}: ${e.message}` : e.message;\n      });\n      return {\n        valid: false,\n        error: `Invalid request: ${errors.join(\"; \")}`,\n      };\n    }\n\n    const request = parsed.data;\n\n    // Normalize to arrays for consistent processing\n    const shapedRequest: ShapedSendEmailRequest = {\n      from: request.from,\n      to: normalizeToArray(request.to),\n      subject: request.subject,\n      text: request.text,\n      html: request.html,\n      cc: normalizeToArray(request.cc),\n      bcc: normalizeToArray(request.bcc),\n      reply_to: normalizeToArray(request.reply_to),\n      headers: request.headers,\n      tags: request.tags,\n      scheduled_at: request.scheduled_at,\n      attachments: request.attachments,\n    };\n\n    // Remove empty arrays\n    if (shapedRequest.cc?.length === 0) delete shapedRequest.cc;\n    if (shapedRequest.bcc?.length === 0) delete shapedRequest.bcc;\n    if (shapedRequest.reply_to?.length === 0) delete shapedRequest.reply_to;\n\n    // Extract enforcement fields\n    const resendEnforcement = extractEnforcementFields(shapedRequest);\n    const enforcement = toSharedEnforcement(resendEnforcement);\n\n    // ----------------------------------------\n    // Plugin-level constraint enforcement\n    // ----------------------------------------\n\n    // Check allowedFromDomains\n    if (\n      constraints.allowedFromDomains &&\n      constraints.allowedFromDomains.length > 0\n    ) {\n      const allowed = constraints.allowedFromDomains as string[];\n      if (!allowed.includes(resendEnforcement.fromDomain)) {\n        return {\n          valid: false,\n          error: `From domain '${resendEnforcement.fromDomain}' not allowed. Allowed: ${allowed.join(\", \")}`,\n        };\n      }\n    }\n\n    // Check allowedToDomains\n    if (\n      constraints.allowedToDomains &&\n      constraints.allowedToDomains.length > 0\n    ) {\n      const allowed = constraints.allowedToDomains as string[];\n      const disallowed = resendEnforcement.toDomains.filter(\n        (d) => !allowed.includes(d),\n      );\n      if (disallowed.length > 0) {\n        return {\n          valid: false,\n          error: `Recipient domain(s) not allowed: ${disallowed.join(\", \")}. Allowed: ${allowed.join(\", \")}`,\n        };\n      }\n    }\n\n    // Check maxRecipients\n    if (constraints.maxRecipients !== undefined) {\n      const max = constraints.maxRecipients as number;\n      if (resendEnforcement.recipientCount > max) {\n        return {\n          valid: false,\n          error: `Recipient count (${resendEnforcement.recipientCount}) exceeds limit (${max})`,\n        };\n      }\n    }\n\n    // Check allowHtml (if set to false)\n    if (constraints.allowHtml === false && resendEnforcement.hasHtml) {\n      return {\n        valid: false,\n        error: \"HTML content is not allowed\",\n      };\n    }\n\n    // Check allowAttachments (if set to false)\n    if (\n      constraints.allowAttachments === false &&\n      resendEnforcement.hasAttachments\n    ) {\n      return {\n        valid: false,\n        error: \"Attachments are not allowed\",\n      };\n    }\n\n    return { valid: true, shapedInput: shapedRequest, enforcement };\n  },\n\n  async execute(\n    action: string,\n    shapedInput: unknown,\n    ctx: PluginExecuteContext,\n    options: PluginExecuteOptions,\n  ): Promise<PluginExecuteResult> {\n    const request = shapedInput as ShapedSendEmailRequest;\n\n    // Build Resend API payload\n    const payload: Record<string, unknown> = {\n      from: request.from,\n      to: request.to,\n      subject: request.subject,\n    };\n\n    // Add optional fields\n    if (request.text) payload.text = request.text;\n    if (request.html) payload.html = request.html;\n    if (request.cc?.length) payload.cc = request.cc;\n    if (request.bcc?.length) payload.bcc = request.bcc;\n    if (request.reply_to?.length) payload.reply_to = request.reply_to;\n    if (request.headers) payload.headers = request.headers;\n    if (request.tags?.length) payload.tags = request.tags;\n    if (request.scheduled_at) payload.scheduled_at = request.scheduled_at;\n    if (request.attachments?.length) payload.attachments = request.attachments;\n\n    // Create timeout controller\n    const controller = new AbortController();\n    const timeout = setTimeout(() => controller.abort(), DEFAULT_TIMEOUT_MS);\n\n    // Combine with provided signal\n    const signal = options.signal\n      ? AbortSignal.any([options.signal, controller.signal])\n      : controller.signal;\n\n    try {\n      const response = await fetch(`${RESEND_API_URL}/emails`, {\n        method: \"POST\",\n        headers: {\n          \"Content-Type\": \"application/json\",\n          Authorization: `Bearer ${ctx.secret}`,\n        },\n        body: JSON.stringify(payload),\n        signal,\n      });\n\n      if (!response.ok) {\n        const errorBody = await response.text();\n        throw new ResendApiError(response.status, errorBody);\n      }\n\n      const json = await response.json();\n      return {\n        response: json,\n        contentType: \"application/json\",\n        usage: this.extractUsage(json),\n      };\n    } finally {\n      clearTimeout(timeout);\n    }\n  },\n\n  extractUsage(_response: unknown): PluginUsageMetrics {\n    // For email, we count as 1 email sent\n    // Future: could track recipients, attachments size, etc.\n    return {\n      // Custom metrics could be added here\n    };\n  },\n\n  mapError(error: unknown): PluginMappedError {\n    if (error instanceof ResendApiError) {\n      return mapResendError(error);\n    }\n\n    if (error instanceof Error && error.name === \"AbortError\") {\n      return {\n        status: 504,\n        code: \"TIMEOUT\",\n        message: \"Request timed out\",\n        retryable: true,\n      };\n    }\n\n    return {\n      status: 500,\n      code: \"INTERNAL_ERROR\",\n      message: error instanceof Error ? error.message : \"Unknown error\",\n      retryable: false,\n    };\n  },\n};\n\nexport default resendPlugin;\n\n// Also export named for flexibility\nexport { resendPlugin };\n","// ============================================\n// RESEND PLUGIN CONTRACTS\n// Shared request/response schemas for proxy and client\n// ============================================\n\nimport { z } from \"zod\";\n\n// ============================================\n// REQUEST SCHEMAS\n// ============================================\n\n/**\n * Email tag for tracking/categorization\n */\nexport const EmailTagSchema = z.object({\n  name: z.string().min(1),\n  value: z.string(),\n});\n\nexport type EmailTag = z.infer<typeof EmailTagSchema>;\n\n/**\n * Attachment schema (base64 encoded content)\n */\nexport const AttachmentSchema = z.object({\n  filename: z.string().min(1),\n  content: z.string(), // Base64 encoded\n  contentType: z.string().optional(),\n});\n\nexport type Attachment = z.infer<typeof AttachmentSchema>;\n\n/**\n * Send Email Request schema\n * Matches Resend API: https://resend.com/docs/api-reference/emails/send-email\n */\nexport const SendEmailRequestSchema = z\n  .object({\n    // Required fields\n    from: z.string().email(\"Invalid 'from' email address\"),\n    to: z.union([\n      z.string().email(\"Invalid 'to' email address\"),\n      z.array(z.string().email(\"Invalid 'to' email address\")).min(1),\n    ]),\n    subject: z.string().min(1, \"Subject cannot be empty\"),\n\n    // Content - at least one required\n    text: z.string().optional(),\n    html: z.string().optional(),\n\n    // Optional recipients\n    cc: z\n      .union([\n        z.string().email(\"Invalid 'cc' email address\"),\n        z.array(z.string().email(\"Invalid 'cc' email address\")),\n      ])\n      .optional(),\n    bcc: z\n      .union([\n        z.string().email(\"Invalid 'bcc' email address\"),\n        z.array(z.string().email(\"Invalid 'bcc' email address\")),\n      ])\n      .optional(),\n\n    // Optional metadata\n    reply_to: z\n      .union([\n        z.string().email(\"Invalid 'reply_to' email address\"),\n        z.array(z.string().email(\"Invalid 'reply_to' email address\")),\n      ])\n      .optional(),\n    headers: z.record(z.string()).optional(),\n    tags: z.array(EmailTagSchema).optional(),\n\n    // Optional scheduling (ISO 8601 datetime)\n    scheduled_at: z.string().datetime().optional(),\n\n    // Optional attachments\n    attachments: z.array(AttachmentSchema).optional(),\n  })\n  .refine((data) => data.text || data.html, {\n    message: \"At least one of 'text' or 'html' must be provided\",\n    path: [\"text\"],\n  });\n\nexport type SendEmailRequest = z.infer<typeof SendEmailRequestSchema>;\n\n// ============================================\n// RESPONSE SCHEMAS\n// ============================================\n\n/**\n * Successful send response from Resend\n */\nexport const SendEmailResponseSchema = z.object({\n  id: z.string(),\n});\n\nexport type SendEmailResponse = z.infer<typeof SendEmailResponseSchema>;\n\n/**\n * Error response from Resend\n */\nexport const ResendErrorResponseSchema = z.object({\n  statusCode: z.number().optional(),\n  message: z.string(),\n  name: z.string().optional(),\n});\n\nexport type ResendErrorResponse = z.infer<typeof ResendErrorResponseSchema>;\n\n// ============================================\n// SHAPED REQUEST (Internal)\n// Normalized for execution with arrays\n// ============================================\n\nexport interface ShapedSendEmailRequest {\n  from: string;\n  to: string[];\n  subject: string;\n  text?: string;\n  html?: string;\n  cc?: string[];\n  bcc?: string[];\n  reply_to?: string[];\n  headers?: Record<string, string>;\n  tags?: EmailTag[];\n  scheduled_at?: string;\n  attachments?: Attachment[];\n}\n\n// ============================================\n// ENFORCEMENT FIELDS\n// ============================================\n\n/**\n * Enforcement fields for email validation.\n * These are extracted during validateAndShape for policy enforcement.\n */\nexport interface ResendEnforcementFields {\n  /** Domain of the 'from' address */\n  fromDomain: string;\n  /** Unique domains across all recipients */\n  toDomains: string[];\n  /** Total count of all recipients (to + cc + bcc) */\n  recipientCount: number;\n  /** Whether HTML content is present */\n  hasHtml: boolean;\n  /** Whether attachments are present */\n  hasAttachments: boolean;\n}\n\n// ============================================\n// PLUGIN CONSTANTS\n// ============================================\n\nexport const PLUGIN_ID = \"mail:resend\" as const;\nexport const RESOURCE_TYPE = \"mail\" as const;\nexport const PROVIDER = \"resend\" as const;\nexport const VERSION = \"0.1.0\";\nexport const PLUGIN_NAME = \"Resend Email\";\n\n/** Supported actions */\nexport const ACTIONS = [\"emails.send\"] as const;\nexport type ResendAction = (typeof ACTIONS)[number];\n\n/** Enforcement knobs this plugin supports */\nexport const ENFORCEMENT_SUPPORT = [\n  \"fromDomain\",\n  \"toDomains\",\n  \"recipientCount\",\n  \"hasHtml\",\n] as const;\n\n// ============================================\n// UTILITY FUNCTIONS\n// ============================================\n\n/**\n * Extract domain from email address\n */\nexport function extractDomain(email: string): string {\n  const parts = email.split(\"@\");\n  return parts[parts.length - 1]?.toLowerCase() || \"\";\n}\n\n/**\n * Normalize email field to array\n */\nexport function normalizeToArray(\n  value: string | string[] | undefined,\n): string[] {\n  if (!value) return [];\n  return Array.isArray(value) ? value : [value];\n}\n\n/**\n * Extract unique domains from email list\n */\nexport function extractUniqueDomains(emails: string[]): string[] {\n  const domains = new Set<string>();\n  for (const email of emails) {\n    domains.add(extractDomain(email));\n  }\n  return Array.from(domains).sort();\n}\n"],"mappings":"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","names":[]}