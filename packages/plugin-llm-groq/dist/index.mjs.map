{"version":3,"sources":["../src/index.ts"],"sourcesContent":["import { z } from \"zod\";\nimport type {\n  PluginContract,\n  PluginResourceConstraints,\n  PluginValidationResult,\n  PluginExecuteContext,\n  PluginExecuteOptions,\n  PluginExecuteResult,\n  PluginUsageMetrics,\n  PluginMappedError,\n} from \"@glueco/shared\";\nimport { createPluginBase } from \"@glueco/shared\";\n\n// ============================================\n// GROQ LLM PLUGIN (OpenAI-Compatible)\n// ============================================\n\nconst GROQ_API_URL = \"https://api.groq.com/openai/v1\";\n\n// Default allowed models if not specified in constraints\nconst DEFAULT_GROQ_MODELS = [\n  \"llama-3.3-70b-versatile\",\n  \"llama-3.1-70b-versatile\",\n  \"llama-3.1-8b-instant\",\n  \"llama3-70b-8192\",\n  \"llama3-8b-8192\",\n  \"mixtral-8x7b-32768\",\n  \"gemma2-9b-it\",\n];\n\n// ============================================\n// REQUEST SCHEMA (OpenAI-compatible)\n// ============================================\n\nconst ChatMessageSchema = z.object({\n  role: z.enum([\"system\", \"user\", \"assistant\", \"tool\"]),\n  content: z\n    .union([\n      z.string(),\n      z.array(\n        z.object({\n          type: z.string(),\n          text: z.string().optional(),\n          image_url: z\n            .object({\n              url: z.string(),\n              detail: z.string().optional(),\n            })\n            .optional(),\n        })\n      ),\n    ])\n    .nullable(),\n  name: z.string().optional(),\n  tool_calls: z\n    .array(\n      z.object({\n        id: z.string(),\n        type: z.literal(\"function\"),\n        function: z.object({\n          name: z.string(),\n          arguments: z.string(),\n        }),\n      })\n    )\n    .optional(),\n  tool_call_id: z.string().optional(),\n});\n\nconst ChatCompletionRequestSchema = z.object({\n  model: z.string(),\n  messages: z.array(ChatMessageSchema),\n  temperature: z.number().min(0).max(2).optional(),\n  top_p: z.number().min(0).max(1).optional(),\n  n: z.number().int().min(1).max(10).optional(),\n  stream: z.boolean().optional(),\n  stop: z.union([z.string(), z.array(z.string())]).optional(),\n  max_tokens: z.number().int().positive().optional(),\n  max_completion_tokens: z.number().int().positive().optional(),\n  presence_penalty: z.number().min(-2).max(2).optional(),\n  frequency_penalty: z.number().min(-2).max(2).optional(),\n  logit_bias: z.record(z.number()).optional(),\n  user: z.string().optional(),\n  tools: z\n    .array(\n      z.object({\n        type: z.literal(\"function\"),\n        function: z.object({\n          name: z.string(),\n          description: z.string().optional(),\n          parameters: z.record(z.unknown()).optional(),\n        }),\n      })\n    )\n    .optional(),\n  tool_choice: z\n    .union([\n      z.literal(\"none\"),\n      z.literal(\"auto\"),\n      z.literal(\"required\"),\n      z.object({\n        type: z.literal(\"function\"),\n        function: z.object({ name: z.string() }),\n      }),\n    ])\n    .optional(),\n  response_format: z\n    .object({\n      type: z.enum([\"text\", \"json_object\"]),\n    })\n    .optional(),\n  seed: z.number().int().optional(),\n});\n\ntype ChatCompletionRequest = z.infer<typeof ChatCompletionRequestSchema>;\n\n// ============================================\n// ERROR HANDLING\n// ============================================\n\nclass GroqApiError extends Error {\n  constructor(\n    public status: number,\n    public body: string\n  ) {\n    super(`Groq API error: ${status}`);\n    this.name = \"GroqApiError\";\n  }\n}\n\nfunction mapGroqError(error: GroqApiError): PluginMappedError {\n  let parsed: { error?: { message?: string; type?: string; code?: string } } =\n    {};\n  try {\n    parsed = JSON.parse(error.body);\n  } catch {\n    // Ignore parse errors\n  }\n\n  const message = parsed.error?.message || error.body;\n\n  switch (error.status) {\n    case 400:\n      return { status: 400, code: \"BAD_REQUEST\", message, retryable: false };\n    case 401:\n      return {\n        status: 401,\n        code: \"UNAUTHORIZED\",\n        message: \"Invalid API key\",\n        retryable: false,\n      };\n    case 403:\n      return { status: 403, code: \"FORBIDDEN\", message, retryable: false };\n    case 404:\n      return { status: 404, code: \"NOT_FOUND\", message, retryable: false };\n    case 429:\n      return { status: 429, code: \"RATE_LIMITED\", message, retryable: true };\n    case 500:\n    case 502:\n    case 503:\n      return {\n        status: error.status,\n        code: \"PROVIDER_ERROR\",\n        message,\n        retryable: true,\n      };\n    default:\n      return {\n        status: error.status,\n        code: \"UNKNOWN\",\n        message,\n        retryable: false,\n      };\n  }\n}\n\n// ============================================\n// PLUGIN IMPLEMENTATION\n// ============================================\n\nconst groqPlugin: PluginContract = {\n  ...createPluginBase({\n    id: \"llm:groq\",\n    resourceType: \"llm\",\n    provider: \"groq\",\n    version: \"1.0.0\",\n    name: \"Groq LLM\",\n    actions: [\"chat.completions\"],\n    supports: {\n      enforcement: [\"model\", \"max_tokens\", \"streaming\"],\n    },\n  }),\n\n  // Extractor reference for enforcement\n  extractors: {\n    \"chat.completions\": {\n      type: \"openai-compatible\",\n    },\n  },\n\n  // Credential schema for UI\n  credentialSchema: {\n    fields: [\n      {\n        name: \"apiKey\",\n        type: \"secret\",\n        label: \"API Key\",\n        description: \"Your Groq API key\",\n        required: true,\n      },\n      {\n        name: \"baseUrl\",\n        type: \"url\",\n        label: \"Base URL\",\n        description: \"Custom API base URL (optional)\",\n        required: false,\n        default: GROQ_API_URL,\n      },\n    ],\n  },\n\n  validateAndShape(\n    action: string,\n    input: unknown,\n    constraints: PluginResourceConstraints\n  ): PluginValidationResult {\n    if (action !== \"chat.completions\") {\n      return { valid: false, error: `Unsupported action: ${action}` };\n    }\n\n    // Parse input\n    const parsed = ChatCompletionRequestSchema.safeParse(input);\n    if (!parsed.success) {\n      return {\n        valid: false,\n        error: `Invalid request: ${parsed.error.errors.map((e) => e.message).join(\", \")}`,\n      };\n    }\n\n    const request = parsed.data;\n\n    // Check allowed models\n    const allowedModels = constraints.allowedModels ?? DEFAULT_GROQ_MODELS;\n    if (!allowedModels.includes(request.model)) {\n      return {\n        valid: false,\n        error: `Model '${request.model}' not allowed. Allowed: ${allowedModels.join(\", \")}`,\n      };\n    }\n\n    // Enforce max tokens\n    const maxTokens = constraints.maxOutputTokens ?? 4096;\n    const requestedTokens = request.max_tokens ?? request.max_completion_tokens;\n\n    if (requestedTokens && requestedTokens > maxTokens) {\n      return {\n        valid: false,\n        error: `max_tokens (${requestedTokens}) exceeds limit (${maxTokens})`,\n      };\n    }\n\n    // Check streaming permission\n    if (request.stream && constraints.allowStreaming === false) {\n      return {\n        valid: false,\n        error: \"Streaming is not allowed for this app\",\n      };\n    }\n\n    // Shape the request (apply defaults, caps)\n    const shapedRequest: ChatCompletionRequest = {\n      ...request,\n      max_tokens: requestedTokens\n        ? Math.min(requestedTokens, maxTokens)\n        : maxTokens,\n    };\n\n    return { valid: true, shapedInput: shapedRequest };\n  },\n\n  async execute(\n    action: string,\n    shapedInput: unknown,\n    ctx: PluginExecuteContext,\n    options: PluginExecuteOptions\n  ): Promise<PluginExecuteResult> {\n    const request = shapedInput as ChatCompletionRequest;\n    const baseUrl = (ctx.config?.baseUrl as string) || GROQ_API_URL;\n\n    const response = await fetch(`${baseUrl}/chat/completions`, {\n      method: \"POST\",\n      headers: {\n        \"Content-Type\": \"application/json\",\n        Authorization: `Bearer ${ctx.secret}`,\n      },\n      body: JSON.stringify(request),\n      signal: options.signal,\n    });\n\n    if (!response.ok) {\n      const errorBody = await response.text();\n      throw new GroqApiError(response.status, errorBody);\n    }\n\n    if (request.stream) {\n      // Return streaming response\n      return {\n        stream: response.body!,\n        contentType: \"text/event-stream\",\n      };\n    } else {\n      // Return JSON response\n      const json = await response.json();\n      return {\n        response: json,\n        contentType: \"application/json\",\n        usage: this.extractUsage(json),\n      };\n    }\n  },\n\n  extractUsage(response: unknown): PluginUsageMetrics {\n    const res = response as {\n      usage?: {\n        prompt_tokens?: number;\n        completion_tokens?: number;\n        total_tokens?: number;\n      };\n      model?: string;\n    };\n\n    return {\n      inputTokens: res.usage?.prompt_tokens,\n      outputTokens: res.usage?.completion_tokens,\n      totalTokens: res.usage?.total_tokens,\n      model: res.model,\n    };\n  },\n\n  mapError(error: unknown): PluginMappedError {\n    if (error instanceof GroqApiError) {\n      return mapGroqError(error);\n    }\n\n    return {\n      status: 500,\n      code: \"INTERNAL_ERROR\",\n      message: error instanceof Error ? error.message : \"Unknown error\",\n      retryable: false,\n    };\n  },\n};\n\nexport default groqPlugin;\n\n// Also export named for flexibility\nexport { groqPlugin };\nexport type { ChatCompletionRequest };\n"],"mappings":"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","names":[]}