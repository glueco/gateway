// scripts/verify-npm-consumer.mjs
import { mkdtemp, writeFile, rm } from "node:fs/promises";
import { tmpdir } from "node:os";
import path from "node:path";
import { spawn } from "node:child_process";

const ORG = "@glueco";

//  Add/remove packages here
const PACKAGES = [
  `${ORG}/shared`,
  `${ORG}/sdk`,
  `${ORG}/plugin-llm-groq`,
  `${ORG}/plugin-llm-openai`,
  `${ORG}/plugin-llm-gemini`,
  `${ORG}/plugin-mail-resend`,
];

// Optional: pin a specific version in CI/local runs.
// Example: VERIFY_VERSION=0.1.0 npm run verify:npm-consumer
const PIN = process.env.VERIFY_VERSION?.trim();
const installSpecs = PACKAGES.map((p) => (PIN ? `${p}@${PIN}` : p));

function run(cmd, args, cwd) {
  return new Promise((resolve, reject) => {
    const p = spawn(cmd, args, { cwd, stdio: "inherit", shell: false });
    p.on("close", (code) => {
      if (code === 0) resolve();
      else
        reject(new Error(`${cmd} ${args.join(" ")} failed with code ${code}`));
    });
  });
}

async function main() {
  const dir = await mkdtemp(path.join(tmpdir(), "glueco-consumer-"));
  console.log(`\n[verify] temp project: ${dir}\n`);

  try {
    // Not a workspace, not your repo — this simulates a real consumer install.
    await writeFile(
      path.join(dir, "package.json"),
      JSON.stringify(
        {
          name: "glueco-consumer-verify",
          private: true,
          type: "module",
        },
        null,
        2,
      ),
    );

    console.log(
      `\n[verify] installing from npm:\n  ${installSpecs.join("\n  ")}\n`,
    );
    await run("npm", ["install", "--silent", ...installSpecs], dir);

    // Import all key entrypoints (root + subpath exports)
    const verifyCode = `
// generated by verify-npm-consumer.mjs
import "${ORG}/shared";
import "${ORG}/sdk";

import "${ORG}/plugin-llm-groq";
import "${ORG}/plugin-llm-groq/proxy";
import "${ORG}/plugin-llm-groq/client";
import "${ORG}/plugin-llm-groq/contracts";

import "${ORG}/plugin-llm-openai";
import "${ORG}/plugin-llm-openai/proxy";
import "${ORG}/plugin-llm-openai/client";
import "${ORG}/plugin-llm-openai/contracts";

import "${ORG}/plugin-llm-gemini";
import "${ORG}/plugin-llm-gemini/proxy";
import "${ORG}/plugin-llm-gemini/client";
import "${ORG}/plugin-llm-gemini/contracts";

import "${ORG}/plugin-mail-resend";
import "${ORG}/plugin-mail-resend/proxy";
import "${ORG}/plugin-mail-resend/client";
import "${ORG}/plugin-mail-resend/contracts";

console.log("[verify] ✅ imports OK (npm consumer install verified)");
`.trimStart();

    await writeFile(path.join(dir, "verify-imports.mjs"), verifyCode);

    console.log("\n[verify] running import test...\n");
    await run("node", ["verify-imports.mjs"], dir);

    console.log("\n[verify] ✅ npm consumer verification passed\n");
  } finally {
    if (process.env.KEEP_VERIFY_TMP === "1") {
      console.log(`[verify] KEEP_VERIFY_TMP=1, leaving temp dir at: ${dir}`);
    } else {
      await rm(dir, { recursive: true, force: true });
      console.log("[verify] cleaned up temp project");
    }
  }
}

main().catch((err) => {
  console.error("\n[verify] ❌ failed:", err?.message ?? err);
  process.exit(1);
});
